---
title: "Graphing Change Over Time"
author: "Andy Grogan-Kaylor"
date: '`r format(Sys.Date(), format="%B %d, %Y")`'
output:
  tufte::tufte_handout: default
  tufte::tufte_html:
    tufte_features:
    - fonts
    - italics
---

```{r global_options, echo=FALSE, warning=FALSE}

library(tufte)

knitr::opts_chunk$set(echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE,
                      fig.height = 2.0, 
                      tidy = FALSE, 
                      cache.extra = packageVersion('tufte'))

options(htmltools.dir.version = FALSE)

```

```{r call_libraries}

library(ggplot2) # beautiful graphs

library(ggthemes) # even more beautiful graphs

library(cowplot) # graph layout

library(knitr) # knitting documents

library(pander) # nice tables

library(xtable) # nice tables that "integrate well" with Tufte Latex

library(png) # for png's

library(grid) # grid graphics

library(RColorBrewer) # colors

library(viridis) # beautiful colors

```

```{r michigan_colors}

michigan_colors=c("#00274c", # blue
                  "#ffcb05", # maize
                  "#a4270b", # tappan red
                  "#e96300", # ross school orange
                  "#beb300", # wave field green
                  "#21c1bc", # taubman teal
                  "#2878ba", # arboretum blue
                  "#7207a5") # ann arbor amethyst

# individual colors

michigan_blue <- "#00274c"

michigan_maize <- "#ffcb05"

tappan_red <- "#a4270b"

ross_school_orange <- "#e96300"

wave_field_green <- "#beb300"

taubman_teal <- "#21c1bc"

arboretum_blue <- "#2878ba"

ann_arbor_amethyst <- "#7207a5"

cool_michigan_colors <- c(michigan_blue, 
                          wave_field_green, 
                          taubman_teal, 
                          arboretum_blue, 
                          ann_arbor_amethyst)

```

```{r make_data}

t <- rep(seq(1:5), 5)

id <- c(rep(1,5),
        rep(2,5),
        rep(3,5),
        rep(4,5),
        rep(5,5)) # id number

id <- factor(id)

outcome <-  c(seq(1,5), 
        seq(5,1, by= -1),
        rep(2,5),
        3, 3, 4, 2, 1,
        seq(0,4, by = 1)) # individual trajectories

group <- c(rep("A", 5),
           rep("B", 5),
           rep("A", 2), rep("C", 3),
           rep("B", 3), rep("A", 2),
           rep("C", 1), rep("A", 4)) # group membership over time

mydata <- data.frame(id, t, outcome)

mydata_wide <- reshape(mydata, 
                       idvar='id', 
                       timevar='t', 
                       direction='wide')

row.names(mydata_wide) <- NULL # remove rownames from wide data

save(mydata, file="graphing change over time.RData")

```


```{r make_plots}

mypointsize <- 2

mylinewidth <- 1 

p <- ggplot(data = mydata, 
            aes(x = t, 
                y = outcome, 
                color = id,
                linetype = id)) + # basic plot structure 
  xlab("time") + ylab("outcome") + 
  theme_tufte() + 
  scale_color_viridis_d() +
  scale_fill_viridis_d() 

myscatterplot <- p + 
  geom_point(size = mypointsize) +
  ggtitle("scatterplot")
    
mylineplot <- p + 
  geom_line(size=mylinewidth) + 
  ggtitle("line plot") 
  
myspaghettiplot <- p + 
  geom_smooth(method = lm, 
              size = mylinewidth, 
              se=FALSE) + 
  geom_smooth(aes(x = t, 
                  y = outcome), 
              size = 2, 
              linetype = "dashed", 
              color = "black", 
              method = lm, 
              se = FALSE) + 
  ggtitle("spaghetti plot") 

myspaghettiplot2 <- p + 
  geom_smooth(aes(x = t, 
                  y = outcome, 
                  group = id), 
              method = lm, 
              size = mylinewidth, 
              se = FALSE, 
              color = "black") + 
  geom_smooth(aes(x = t, 
                  y = outcome), 
              size = 2, 
              linetype = "dashed", 
              color = "black", 
              method = lm, 
              se = FALSE) + 
  ggtitle("spaghetti plot") 

mysmoother <- p + 
  geom_smooth(size = mylinewidth, 
              span = 1.0, 
              se = FALSE) + 
  ggtitle("smoother")

mybarchart <- p + 
  geom_bar(aes(fill = id), 
           stat = "identity", 
           position = "dodge") + 
  ggtitle("bar graph") 

newdata <- subset(mydata, 
                  t == 1 | t == 5) # newdata with endpoints only

ratio <- bank_slopes(t, outcome) # optimal aspect ratio

myslopegraph <- ggplot(data = newdata, 
                       aes(x = t, 
                           y = outcome, 
                           color = id, 
                           fill = id,
                           linetype = id)) + 
  geom_line(size = mylinewidth, 
            show.legend = FALSE) + 
  geom_point(size = 3, 
             shape = 21) + 
  ggtitle("slopegraph") +
  xlab("time") + 
  ylab("outcome") +
  scale_y_continuous(breaks=c(0, 1, 2, 3, 4, 5)) + 
  scale_x_continuous(breaks=c(1,5)) + 
  theme_tufte() + 
  scale_color_viridis_d() +
  scale_fill_viridis_d()


```

# Graphs

```{r, fig.margin=TRUE}

myscatterplot

```

`r newthought('We start')` in thinking about graphing change over time with a scatterplot.[^scatterplot] [^color]

[^scatterplot]:  Scatterplots show every data point.  However, with many data points, scatterplots may become overcomplicated, and difficult to interpret.  Points may even be plotted over other data points.

[^color]: Note that we are using *color* and *line type* to distinguish different individuals. This may not always be possible, especially when there are a large number of individuals in the data.

`r newthought('A natural next step')` is to connect the dots of a scatterplot with straight line segments to form a line plot. [^smallmultiples] 

[^smallmultiples]: With any of the options discussed, one may consider *small multiples* where each individual trajectory is placed in its own sub-graph.

```{r, fig.margin=TRUE}

mylineplot + facet_wrap(~id) 

```

\marginnote{Alternatively, rather than connecting observations with straight lines, or estimating an overall straight line trajectory for each individual, it may be useful to "smooth" the trajectories by drawing curved lines between individual observations.}

```{r fig.margin=TRUE}

mysmoother

```

\marginnote{One needs to be careful, however, as the smoothed trajectories may give the impression of having more data points than one actually has.}

```{r}

mylineplot

```

`r newthought('Instead of simply connecting the observations')`, one may estimate an individual linear trajectory.  In *multilevel modeling* these line plots showing individual estimated linear trajectories are sometimes called *spaghetti plots*.

```{r}

myspaghettiplot

```

\newpage

`r newthought('An increasingly popular option')` is a slope graph.[^slopegraph]

[^slopegraph]:  In order to be clear and effective, a slope graph may often only show the outcome at the beginning point, and at the end point.  A slope graph may be less satisfactory when there are multiple timepoints.

\marginnote{The small multiple idea works with a slopegraph as well.} 

```{r fig.margin=TRUE, eval=TRUE}

myslopegraph + facet_wrap(~id) 

```

```{r fig.margin=FALSE, eval=TRUE}

myslopegraph

```

# The Data Used In This Example Are Simulated.

\marginnote{Long Data}

```{r, eval = TRUE, fig.margin=TRUE, fig.height= 9}

img <- readPNG("longdata.png")

grid.raster(img)

```

`r newthought('Many data sets')`, but not all, are originally created in the *wide* format--as shown below--where every row of data is an *individual*, and an individual only has a *single row*.  Ideally, every row in *wide* data is uniquely identified by an individual *id* number.  

```{r, eval=TRUE, fig.fullwidth = TRUE, fig.width = 10}

panderOptions('table.continues', ' ')

pander(mydata_wide, title="Data in wide format")

```

Generally, for graphing change over time, it is most appropriate to have data that are in a *long* format, as shown in the margin.  In *long* data every row represents a particular *measurement occasion* for a *particular individual*.  Each individual in the data set thus has *multiple rows*.  Ideally, every row in data in the *long* format is uniquely identified by the combination of an *id* number and a *study wave*.

Data can be *reshaped* from *wide* to *long* format, and *vice versa*.  Two straightforward options are the `reshape` command, as available in both [Stata](http://www.stata.com) and [R](https://www.r-project.org/).

*****
\footnotesize

Graphics made with ggplot2[^ggplot2] created by Hadley Wickham.

Designed using the Tufte-\LaTeX\ [^tufte_latex] variant of [RMarkdown](http://rmarkdown.rstudio.com/tufte_handout_format.html)
which is inspired by the works of Edward Tufte[^books_be]. 

[^ggplot2]: http://ggplot2.org/
[^tufte_latex]: https://code.google.com/p/tufte-latex/
[^books_be]: http://www.edwardtufte.com/tufte/books_be

[*Graphing Change Over Time*](https://agroganweb.wordpress.com/data-visualization-dataviz/) by Andrew Grogan-Kaylor is licensed under a [Creative Commons Attribution-ShareAlike 4.0 International License](http://creativecommons.org/licenses/by-sa/4.0/). 













